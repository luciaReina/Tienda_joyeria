<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Cesta de la compra</title>
    <link rel="stylesheet" th:href="@{/css/carrito.css}">
    <script>
        // Función para decrementar la cantidad de un producto
        function decrementar(productoId) {
            // Implementa aquí la lógica para enviar una petición a tu backend
            // para decrementar la cantidad del producto con productoId
            // Por ejemplo, usando fetch API:
            fetch('/carrito/decrementar/' + productoId, { method: 'POST' })
             .then(response => { if(response.ok) window.location.reload(); })
             .catch(error => console.error('Error:', error));
            alert('Decrementar producto ID: ' + productoId); // Placeholder
        }

        // Función para incrementar la cantidad de un producto
        function incrementar(productoId) {
            // Implementa aquí la lógica para enviar una petición a tu backend
            // para incrementar la cantidad del producto con productoId
            // Por ejemplo, usando fetch API:
            fetch('/carrito/incrementar/' + productoId, { method: 'POST' })
             .then(response => { if(response.ok) window.location.reload(); })
             .catch(error => console.error('Error:', error));
            alert('Incrementar producto ID: ' + productoId); // Placeholder
        }

        // Para borrar un item del carrito (ejemplo, si tienes un botón de borrar)
        function eliminarItem(itemId) {
            if (confirm('¿Estás seguro de que quieres eliminar este artículo del carrito?')) {
                // Aquí necesitarías el token CSRF si Spring Security está habilitado
                const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute('content');
                const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

                fetch('/carrito/eliminar/' + itemId, { // Asume un endpoint /carrito/eliminar/{idItemCarrito}
                    method: 'POST', // O 'DELETE' con HiddenHttpMethodFilter si prefieres
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded', // O 'application/json' si envías JSON
                        [csrfHeader]: csrfToken // Añadir el token CSRF
                    },
                    body: '_method=DELETE' // Si usas HiddenHttpMethodFilter para simular DELETE
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload(); 
                    } else {
                        response.text().then(text => alert('Error al eliminar el artículo: ' + text));
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }
    </script>
    </head>
<body>
<div class="carrito-container">
    <header class="cabecera">
        <h2>IVI REINA</h2>
        <div class="progreso">
            <span class="activo">Cart</span> → <span>Shipping & Payment</span> → <span>Confirmation</span>
        </div>
    </header>
    
     <h3 th:text="'Welcome, ' + ${loggedUser}"></h3>

    <div th:if="${carrito == null or #lists.isEmpty(carrito.itemsCarrito)}" class="carrito-vacio">
        Your shopping cart is empty.
    </div>

    <div th:if="${carrito != null and !#lists.isEmpty(carrito.itemsCarrito)}" class="carrito-contenido">
        <div class="item" th:each="item : ${carrito.itemsCarrito}">
            <img th:src="@{/img/{img}(img=${item.producto.imgUrl})}" alt="Producto" />
            <div>
                <h3 th:text="${item.producto.nombre}"></h3>
                <p>Ref: <span th:text="${item.producto.descripcion}"></span></p>
                <p>Unit Price: <strong th:text="${#numbers.formatDecimal(item.producto.precio, 0, 'POINT', 2, 'POINT')} + '€'"></strong></p>
                <p>Item Subtotal: <strong th:text="${#numbers.formatDecimal(item.subTotal, 0, 'POINT', 2, 'POINT')} + '€'"></strong></p>
                <div class="cantidad">
                    <button type="button" th:onclick="'decrementar(' + ${item.producto.idProducto} + ')'">-</button>
                    <span th:text="${item.cantidad}">1</span>
                    <button type="button" th:onclick="'incrementar(' + ${item.producto.idProducto} + ')'">+</button>
                </div>
            </div>
        </div>

        <div class="totales">
            <p>SUBTOTAL:
                <span th:text="${#numbers.formatDecimal(carrito.subTotal, 0, 'POINT', 2, 'POINT')} + '€'"></span>
            </p>
            <p>SHIPPING COSTS:
                <span th:text="${#numbers.formatDecimal(carrito.gastosEnvio, 0, 'POINT', 2, 'POINT')} + '€'"></span>
            </p>
            <p><strong>
                TOTAL:
                <span th:text="${#numbers.formatDecimal(carrito.total, 0, 'POINT', 2, 'POINT')} + '€'"></span>
            </strong></p>
        </div>

        <form th:action="@{/api/payments/create}" method="post">
            <button type="submit">PLACE ORDER</button>
        </form>
    </div>
</div>
</body>
</html>